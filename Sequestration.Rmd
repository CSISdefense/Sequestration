---
title: "Prime contracting for involving U.S.-Canada vendors"
author: "Greg Sanders"
date: "July 14, 2016"
output: 
  html_document: 
    fig_height: 4.75
    fig_width: 8
    keep_md: yes
    number_sections: yes
    toc: yes
---

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r Requirements}
library(plyr)
require(ggplot2)
require(scales)

# setwd("K:\\Development\\Sequestration")
setwd("D:\\Users\\Greg Sanders\\Documents\\Development\\Sequestration")

# Path<-"K:\\2007-01 PROFESSIONAL SERVICES\\R scripts and data\\"
Path<-"D:\\Users\\Greg Sanders\\Documents\\Development\\R-scripts-and-data\\"
source(paste(Path,"lookups.r",sep=""))
source(paste(Path,"helper.r",sep=""))


Coloration<-read.csv(
  paste(Path,"Lookups\\","Lookup_coloration.csv",sep=""),
  header=TRUE, sep=",", na.strings="NA", dec=".", strip.white=TRUE, 
  stringsAsFactors=FALSE
)

#Clear out lines from the coloration CSV where no variable is listed.
Coloration<-subset(Coloration, variable!="")
```




```{r ReadAndProcess}

FSRShistory  <- read.csv(
    file.path("Data","Contract_FSRSinFPDShistory.csv"),
    header = TRUE, sep = ",", dec = ".", strip.white = TRUE, 
    na.strings = c("NULL","NA",""),
    stringsAsFactors = TRUE
)
FSRShistory<-subset(FSRShistory,fiscal_year>=1990)
FSRShistory<-apply_lookups(Path,FSRShistory)

CanadaSample<-subset(FSRShistory,Customer %in% c("Defense","NASA","DHS","State and IAP") | 
                         SubCustomer %in% c("Interior","Transportation","Justice"))



# CanadaSample$Category[CanadaSample$AnyIsSmall==0]<-"Never Small"
# CanadaSample$Category[CanadaSample$AlwaysIsSmall==1]<-"Always Small"
# CanadaSample$Category[CanadaSample$AlwaysIsSmall==0 & 
#                              CanadaSample$AnyIsSmall==1]<-"Sometimes Small"
# 

CanadaCategoryNotVendor<-ddply(CanadaSample,.(Fiscal.Year,
                                            Customer,SubCustomer,SubCustomer.component,SubCustomer.sum,SubCustomer.detail,
                                            PlatformPortfolio,PlatformPortfolio.sum,
                                            ProductServiceOrRnDarea,ServicesCategory.sum,
                                            ProductOrServiceCode,
                                            ProductOrServiceCodeText
                                            ),
      summarize,
      # count=length(FiscalYear),
      # ObligatedAmount=sum(ObligatedAmount),
      Obligation.2014=sum(Obligation.2014)
      )

write.csv(CanadaCategoryNotVendor,"Data\\CanadaSampleCustomerPlatformBucket.csv")

CanadaCategoryNotVendor$Agency<-as.character(CanadaCategoryNotVendor$Customer)
CanadaCategoryNotVendor$Agency[CanadaCategoryNotVendor$Agency=="Other Agencies"]<-
    as.character(CanadaCategoryNotVendor$SubCustomer[CanadaCategoryNotVendor$Agency=="Other Agencies"])
CanadaCategoryNotVendor$Agency<-factor(CanadaCategoryNotVendor$Agency)



# DunsCountyByPercent<-ddply(CanadaSample,.(RoundedPercentSmall,AnyIsSmall,AlwaysIsSmall,Category),
#       summarize,
#       count=length(FiscalYear),
#       ObligatedAmount=sum(ObligatedAmount),
#       ObligatedAmountisSmall=sum(ObligatedAmountisSmall)
#       )

# DunsCountyByPercent$SmallValueThreshold[DunsCountyByPercent$RoundedPercentSmall>=0.25]<-">=25%"
# DunsCountyByPercent$SmallValueThreshold[DunsCountyByPercent$RoundedPercentSmall<0.25 &
#                                               DunsCountyByPercent$RoundedPercentSmall>=0.1]<-"[10%-25%)"
# 
# DunsCountyByPercent$SmallValueThreshold[DunsCountyByPercent$RoundedPercentSmall<0.1 &
#                                         DunsCountyByPercent$RoundedPercentSmall>=0.01]<-"[1%-10%)"
# DunsCountyByPercent$SmallValueThreshold[DunsCountyByPercent$RoundedPercentSmall<0.01 ]<-"<1%"
# # DunsCountyByPercent$SmallValueThreshold[is.na(DunsCountyByPercent$RoundedPercentSmall)]<-"NA"
# DunsCountyByPercent$SmallValueThreshold<-ordered(DunsCountyByPercent$SmallValueThreshold,levels=c("<1%","[1%-10%)","[10%-25%)",">=25%"))

```

```{r}
FSRSstudy<-read.csv(file.path("Data","Contract_FSRSinFPDShistory.csv"),
                     na.strings=c("NULL","NA"),
                     header=TRUE)
FSRSstudy<-subset(FSRSstudy,fiscal_year>1990)
FSRSstudy<-apply_lookups(Path,FSRSstudy)


```

```{r PrimeContactSubStudy}
FSRSstudy<-read.csv(file.path("Data","Contract_FSRSinFPDShistory.csv"),
                     na.strings=c("NULL","NA"),
                     header=TRUE)
FSRSstudy<-subset(FSRSstudy,fiscal_year>1990)
FSRSstudy<-apply_lookups(Path,FSRSstudy)


PrimeContract2011<-ddply(subset(FSRSstudy,Fiscal.Year>=2011),
      .(CSIScontractID,IsSubcontractReportingContract),
      summarise,
      Obligation.2014=sum(Obligation.2014))

PrimeContractCount<-ddply(FSRSstudy2011,
      .(IsSubcontractReportingContract),
      summarise,
      Obligation.2014=sum(Obligation.2014),
      ContractCount=length(CSIScontractID))

write("PrimeContract.csv",PrimeContract




```{r PrimeContactSubStudy}
FSRSstudy<-read.csv(file.path("Data","Contract_FSRSinFPDShistory.csv"),
                     na.strings=c("NULL","NA"),
                     header=TRUE)
FSRSstudy<-subset(FSRSstudy,fiscal_year>1990)
FSRSstudy<-apply_lookups(Path,FSRSstudy)


PrimeContract2011<-ddply(subset(FSRSstudy,Fiscal.Year>=2011),
      .(CSIScontractID,IsSubcontractReportingContract),
      summarise,
      Obligation.2014=sum(Obligation.2014))

PrimeContractCount<-ddply(FSRSstudy2011,
      .(IsSubcontractReportingContract),
      summarise,
      Obligation.2014=sum(Obligation.2014),
      ContractCount=length(CSIScontractID))

write("PrimeContract.csv",PrimeContract
